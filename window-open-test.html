<!DOCTYPE html>
<html>
<head>
    <title>Window Open Data URL Test</title>
    <script src="https://unpkg.com/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .result {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
            background-color: #f8f9fa;
        }
        .success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        iframe {
            width: 100%;
            height: 300px;
            border: 1px solid #ccc;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>Window Open Data URL Test</h1>
    
    <div class="test-section">
        <h2>Test 1: Direct Window Open with Data URL</h2>
        <button id="test1">Open Window with Data URL Image</button>
        <div id="result1" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>Test 2: Window Open with HTML Content Including Data URL</h2>
        <button id="test2">Open Window with HTML Content</button>
        <div id="result2" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>Test 3: Blob URL Approach</h2>
        <button id="test3">Open Window with Blob URL</button>
        <div id="result3" class="result"></div>
    </div>

    <script>
        // Test 1: Direct window.open with data URL
        document.getElementById('test1').addEventListener('click', async () => {
            const button = document.getElementById('test1');
            const result = document.getElementById('result1');
            
            button.disabled = true;
            result.innerHTML = 'Generating...';
            result.className = 'result';
            
            try {
                // Generate a simple QR code
                const dataUrl = await QRCode.toDataURL('Test Data', {
                    width: 120,
                    margin: 2,
                    errorCorrectionLevel: 'M'
                });
                
                result.innerHTML = `<p>Generated Data URL length: ${dataUrl.length}</p>`;
                
                // Try to open in a new window
                const newWindow = window.open(dataUrl, '_blank');
                
                if (newWindow) {
                    result.innerHTML += '<p><strong>Success!</strong> Window opened</p>';
                    result.className = 'result success';
                } else {
                    result.innerHTML += '<p><strong>Blocked!</strong> Popup blocker prevented window from opening</p>';
                    result.className = 'result error';
                }
            } catch (error) {
                result.innerHTML = `
                    <p><strong>Error:</strong></p>
                    <p>${error.message}</p>
                `;
                result.className = 'result error';
            } finally {
                button.disabled = false;
            }
        });

        // Test 2: Window open with HTML content including data URL
        document.getElementById('test2').addEventListener('click', async () => {
            const button = document.getElementById('test2');
            const result = document.getElementById('result2');
            
            button.disabled = true;
            result.innerHTML = 'Generating...';
            result.className = 'result';
            
            try {
                // Generate a QR code
                const dataUrl = await QRCode.toDataURL('Test Receipt Data', {
                    width: 120,
                    margin: 2,
                    errorCorrectionLevel: 'M'
                });
                
                result.innerHTML = `<p>Generated Data URL length: ${dataUrl.length}</p>`;
                
                // Create HTML content similar to the receipt
                const htmlContent = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Test Receipt</title>
                        <style>
                            body {
                                font-family: 'Courier New', monospace;
                                max-width: 320px;
                                margin: 0 auto;
                                padding: 10px;
                            }
                            .qr-section {
                                text-align: center;
                                margin: 15px 0;
                                padding: 10px;
                                border-top: 1px dashed #000;
                            }
                            .qr-label {
                                font-size: 9px;
                                margin-bottom: 5px;
                            }
                            .qr-code-img {
                                max-width: 120px;
                                height: auto;
                                margin: 10px auto;
                                display: block;
                            }
                        </style>
                    </head>
                    <body>
                        <div class="qr-section">
                            <div class="qr-label">Scan for Details</div>
                            <img src="${dataUrl}" class="qr-code-img" alt="Receipt QR Code" 
                                 onerror="console.error('QR Code failed to load'); this.style.display='none'; this.nextElementSibling.style.display='block'" />
                            <div style="display: none; font-size: 8px; color: #666;">QR Code failed to load</div>
                            <div style="font-size: 8px; margin-top: 5px;">Receipt #: TEST-001</div>
                        </div>
                    </body>
                    </html>
                `;
                
                // Open window with HTML content
                const receiptWindow = window.open('', '_blank');
                if (receiptWindow) {
                    receiptWindow.document.open();
                    receiptWindow.document.write(htmlContent);
                    receiptWindow.document.close();
                    receiptWindow.focus();
                    
                    result.innerHTML += '<p><strong>Success!</strong> HTML content written to window</p>';
                    result.className = 'result success';
                } else {
                    result.innerHTML += '<p><strong>Blocked!</strong> Popup blocker prevented window from opening</p>';
                    result.className = 'result error';
                }
            } catch (error) {
                result.innerHTML = `
                    <p><strong>Error:</strong></p>
                    <p>${error.message}</p>
                    <pre>${error.stack}</pre>
                `;
                result.className = 'result error';
            } finally {
                button.disabled = false;
            }
        });

        // Test 3: Blob URL approach
        document.getElementById('test3').addEventListener('click', async () => {
            const button = document.getElementById('test3');
            const result = document.getElementById('result3');
            
            button.disabled = true;
            result.innerHTML = 'Generating...';
            result.className = 'result';
            
            try {
                // Generate a QR code
                const dataUrl = await QRCode.toDataURL('Test Receipt Data', {
                    width: 120,
                    margin: 2,
                    errorCorrectionLevel: 'M'
                });
                
                result.innerHTML = `<p>Generated Data URL length: ${dataUrl.length}</p>`;
                
                // Create HTML content
                const htmlContent = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Test Receipt</title>
                        <style>
                            body {
                                font-family: 'Courier New', monospace;
                                max-width: 320px;
                                margin: 0 auto;
                                padding: 10px;
                            }
                            .qr-section {
                                text-align: center;
                                margin: 15px 0;
                                padding: 10px;
                                border-top: 1px dashed #000;
                            }
                            .qr-label {
                                font-size: 9px;
                                margin-bottom: 5px;
                            }
                            .qr-code-img {
                                max-width: 120px;
                                height: auto;
                                margin: 10px auto;
                                display: block;
                            }
                        </style>
                    </head>
                    <body>
                        <div class="qr-section">
                            <div class="qr-label">Scan for Details</div>
                            <img src="${dataUrl}" class="qr-code-img" alt="Receipt QR Code" 
                                 onerror="console.error('QR Code failed to load'); this.style.display='none'; this.nextElementSibling.style.display='block'" />
                            <div style="display: none; font-size: 8px; color: #666;">QR Code failed to load</div>
                            <div style="font-size: 8px; margin-top: 5px;">Receipt #: TEST-001</div>
                        </div>
                    </body>
                    </html>
                `;
                
                // Create blob and URL
                const blob = new Blob([htmlContent], { type: 'text/html' });
                const blobUrl = URL.createObjectURL(blob);
                
                // Open window with blob URL
                const receiptWindow = window.open(blobUrl, '_blank');
                
                if (receiptWindow) {
                    result.innerHTML += '<p><strong>Success!</strong> Blob URL window opened</p>';
                    result.className = 'result success';
                    
                    // Clean up URL after some time
                    setTimeout(() => URL.revokeObjectURL(blobUrl), 5000);
                } else {
                    result.innerHTML += '<p><strong>Blocked!</strong> Popup blocker prevented window from opening</p>';
                    result.className = 'result error';
                }
            } catch (error) {
                result.innerHTML = `
                    <p><strong>Error:</strong></p>
                    <p>${error.message}</p>
                `;
                result.className = 'result error';
            } finally {
                button.disabled = false;
            }
        });
    </script>
</body>
</html>